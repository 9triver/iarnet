---
- name: 安装 iarnet 依赖
  hosts: iarnet_nodes
  become: yes
  vars:
    go_version: "1.25.0"
    nodejs_version: "20"  # Node.js 版本（与 Dockerfile 保持一致）
    
  tasks:
    - name: 更新包列表
      apt:
        update_cache: yes
        cache_valid_time: 0  # 设置为 0 强制更新，确保获取最新包信息

    - name: 安装基础依赖
      apt:
        name:
          - curl
          - wget
          - git
          - build-essential
          - pkg-config
        state: present

    - name: 安装 Go 语言环境
      block:
        - name: 检查 Go 是否已安装
          command: go version
          register: go_version_check
          failed_when: false
          changed_when: false

        - name: 下载 Go（优先使用镜像源）
          block:
            - name: 尝试从golang.google.cn下载
              get_url:
                url: "https://golang.google.cn/dl/go{{ go_version }}.linux-amd64.tar.gz"
                dest: /tmp/go.tar.gz
                mode: '0644'
                timeout: 60
                validate_certs: no
              ignore_errors: yes
              register: go_download_mirror
            
            - name: 如果镜像源失败，尝试官方源
              get_url:
                url: "https://go.dev/dl/go{{ go_version }}.linux-amd64.tar.gz"
                dest: /tmp/go.tar.gz
                mode: '0644'
                timeout: 60
              when: go_download_mirror is failed or go_download_mirror is skipped
              ignore_errors: yes
              register: go_download_official
            
            - name: 如果都失败，尝试使用apt安装
              apt:
                name: golang-go
                state: present
              when: (go_download_mirror is failed or go_download_mirror is skipped) and (go_download_official is failed or go_download_official is skipped)
              ignore_errors: yes
              register: go_apt_install
            
            - name: 检查下载或安装是否成功
              fail:
                msg: "无法下载Go {{ go_version }}，也无法通过apt安装。请检查网络连接或手动安装Go。"
              when: 
                - go_version_check.rc != 0
                - (go_download_mirror is failed or go_download_mirror is skipped)
                - (go_download_official is failed or go_download_official is skipped)
                - (go_apt_install is failed or go_apt_install is skipped)
          when: go_version_check.rc != 0

        - name: 删除旧版 Go（如果存在）
          file:
            path: /usr/local/go
            state: absent
          when: 
            - go_version_check.rc != 0
            - go_download_mirror is succeeded or go_download_official is succeeded

        - name: 解压 Go（从下载的文件）
          unarchive:
            src: /tmp/go.tar.gz
            dest: /usr/local
            remote_src: yes
          when: 
            - go_version_check.rc != 0
            - go_download_mirror is succeeded or go_download_official is succeeded
          register: go_extract_result
          
        - name: 检查Go文件是否存在（如果使用apt安装）
          stat:
            path: /usr/bin/go
          when: 
            - go_version_check.rc != 0
            - (go_download_mirror is failed or go_download_mirror is skipped)
            - (go_download_official is failed or go_download_official is skipped)
            - go_apt_install is succeeded
          register: go_apt_check

        - name: 设置 Go 环境变量（从tar.gz安装）
          lineinfile:
            path: /etc/profile.d/go.sh
            line: "{{ item }}"
            create: yes
            mode: '0644'
          loop:
            - 'export PATH=$PATH:/usr/local/go/bin'
            - 'export GOPATH=$HOME/go'
            - 'export PATH=$PATH:$GOPATH/bin'
          when: 
            - go_version_check.rc != 0
            - go_download_mirror is succeeded or go_download_official is succeeded
            
        - name: 设置 Go 环境变量（从apt安装）
          lineinfile:
            path: /etc/profile.d/go.sh
            line: "{{ item }}"
            create: yes
            mode: '0644'
          loop:
            - 'export GOPATH=$HOME/go'
            - 'export PATH=$PATH:$GOPATH/bin'
          when: 
            - go_version_check.rc != 0
            - (go_download_mirror is failed or go_download_mirror is skipped)
            - (go_download_official is failed or go_download_official is skipped)
            - go_apt_install is succeeded

    - name: 安装 gRPC 相关依赖
      apt:
        name:
          - libprotobuf-dev
          - protobuf-compiler
          - libgrpc-dev
          - libgrpc++-dev
        state: present

    - name: 检查 ZeroMQ 运行时库是否已安装
      command: dpkg -l | grep -E "^ii\s+(libzmq5|libczmq4|libsodium23)" || echo "未安装"
      register: zmq_runtime_check
      changed_when: false
      failed_when: false

    - name: 显示 ZeroMQ 运行时库检查结果
      debug:
        msg: "{{ zmq_runtime_check.stdout_lines }}"

    - name: 安装 ZeroMQ 依赖（开发库和运行时库）
      apt:
        name:
          - libzmq5          # ZeroMQ 运行时库
          - libzmq3-dev      # ZeroMQ 开发库（用于编译）
          - libczmq4          # CZMQ 运行时库
          - libczmq-dev       # CZMQ 开发库（用于编译）
          - libsodium23       # libsodium 运行时库（ZeroMQ 加密依赖）
          - libsodium-dev     # libsodium 开发库（用于编译）
        state: present
        update_cache: yes
        cache_valid_time: 0  # 强制更新缓存，确保获取最新包信息
      register: zmq_install_result

    - name: 显示 ZeroMQ 安装结果
      debug:
        msg: "{{ zmq_install_result }}"

    - name: 验证 ZeroMQ 运行时库安装
      command: dpkg -l | grep -E "^ii\s+(libzmq5|libczmq4|libsodium23)"
      register: zmq_runtime_verify
      changed_when: false
      failed_when: false

    - name: 显示 ZeroMQ 运行时库验证结果
      debug:
        msg: "{{ zmq_runtime_verify.stdout_lines }}"
    
    - name: 检查 ZeroMQ 库文件是否存在
      command: find /usr/lib /usr/lib/x86_64-linux-gnu -name "libzmq.so*" -o -name "libczmq.so*" 2>/dev/null | head -10
      register: zmq_lib_files
      changed_when: false
      failed_when: false
    
    - name: 显示 ZeroMQ 库文件位置
      debug:
        msg: "{{ zmq_lib_files.stdout_lines }}"
    
    - name: 检查库依赖关系
      command: ldd /usr/lib/x86_64-linux-gnu/libzmq.so.5 2>/dev/null || ldd /usr/lib/libzmq.so.5 2>/dev/null || echo "库文件未找到"
      register: zmq_lib_deps
      changed_when: false
      failed_when: false
    
    - name: 显示 ZeroMQ 库依赖
      debug:
        msg: "{{ zmq_lib_deps.stdout_lines }}"
    
    - name: 更新动态链接库缓存
      command: ldconfig
      become: yes
      changed_when: false
    
    - name: 验证库是否能被正确加载
      command: ldconfig -p | grep -E "(libzmq|libczmq|libsodium)" || echo "库未在缓存中"
      register: ldconfig_check
      changed_when: false
      failed_when: false
    
    - name: 显示动态链接库缓存检查结果
      debug:
        msg: "{{ ldconfig_check.stdout_lines }}"
    
    - name: 测试 ZeroMQ 库加载（使用 Python 测试）
      command: python3 -c "import ctypes; lib = ctypes.CDLL('libzmq.so.5'); print('libzmq.so.5 loaded successfully')" || python3 -c "import ctypes; lib = ctypes.CDLL('libzmq.so'); print('libzmq.so loaded successfully')" || echo "库加载测试失败"
      register: zmq_load_test
      changed_when: false
      failed_when: false
    
    - name: 显示库加载测试结果
      debug:
        msg: "{{ zmq_load_test.stdout_lines }}"
    
    - name: 检查 libzmq5 的依赖包
      command: apt-cache depends libzmq5 | grep -E "Depends|Recommends" | head -20
      register: zmq_deps
      changed_when: false
      failed_when: false
    
    - name: 显示 libzmq5 依赖信息
      debug:
        msg: "{{ zmq_deps.stdout_lines }}"
    
    - name: 确保所有 ZeroMQ 相关包都已安装（包括依赖）
      apt:
        name:
          - libzmq5
          - libczmq4
          - libsodium23
        state: present
        install_recommends: yes
        force_apt_get: yes
      register: zmq_final_check
    
    - name: 检查 libzmq5 的依赖包
      command: apt-cache depends libzmq5 | grep -E "Depends|Recommends" | head -20
      register: zmq_deps
      changed_when: false
      failed_when: false
    
    - name: 显示 libzmq5 依赖信息
      debug:
        msg: "{{ zmq_deps.stdout_lines }}"
    
    - name: 确保所有 ZeroMQ 相关包都已安装（包括依赖）
      apt:
        name:
          - libzmq5
          - libczmq4
          - libsodium23
        state: present
        install_recommends: yes
        force_apt_get: yes
      register: zmq_final_check

    - name: 安装其他运行时依赖
      apt:
        name:
          - ca-certificates
          - libssl-dev
          - libsqlite3-dev
        state: present

    - name: 安装 Node.js 和 npm（前端运行需要）
      block:
        - name: 检查 Node.js 是否已安装
          command: node --version
          register: node_version_check
          failed_when: false
          changed_when: false

        - name: 添加 NodeSource APT 仓库（使用官方脚本）
          shell: |
            curl -fsSL https://deb.nodesource.com/setup_{{ nodejs_version }}.x | bash - || true
          when: node_version_check.rc != 0
          ignore_errors: yes
          register: nodesource_setup
          changed_when: nodesource_setup.rc == 0

        - name: 安装 Node.js（从 NodeSource）
          apt:
            name: nodejs
            state: present
            update_cache: yes
          when: 
            - node_version_check.rc != 0
            - nodesource_setup is succeeded
          ignore_errors: yes
          register: nodejs_nodesource_install

        - name: 安装 Node.js（从默认仓库，如果 NodeSource 失败）
          apt:
            name:
              - nodejs
              - npm
            state: present
          when: 
            - node_version_check.rc != 0
            - (nodesource_setup is failed or nodesource_setup is skipped) or (nodejs_nodesource_install is failed or nodejs_nodesource_install is skipped)
          ignore_errors: yes
          register: nodejs_apt_install

        - name: 检查 Node.js 安装是否成功
          fail:
            msg: "无法安装 Node.js。请检查网络连接或手动安装 Node.js {{ nodejs_version }}。"
          when: 
            - node_version_check.rc != 0
            - (nodejs_nodesource_install is failed or nodejs_nodesource_install is skipped)
            - (nodejs_apt_install is failed or nodejs_apt_install is skipped)

        - name: 验证 Node.js 和 npm 版本
          shell: |
            echo "=== Node.js ==="
            node --version || echo "node not found"
            echo "=== npm ==="
            npm --version || echo "npm not found"
          register: nodejs_verify
          changed_when: false
          failed_when: false

    - name: 安装 Docker（iarnet 节点需要）
      block:
        - name: 检查 Docker 是否已安装
          command: docker --version
          register: docker_version_check
          changed_when: false
          failed_when: false

        - name: 跳过已安装 Docker 的节点
          meta: end_host
          when: docker_version_check.rc == 0

        - name: 安装 Docker 依赖包
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present

        - name: 创建 keyrings 目录
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'

        - name: 添加 Docker GPG 密钥（优先使用国内镜像源）
          block:
            - name: 删除可能存在的空 GPG 密钥文件
              file:
                path: /etc/apt/keyrings/docker.gpg
                state: absent
              ignore_errors: yes
            
            - name: 优先尝试使用阿里云镜像源下载 GPG 密钥
              shell: |
                curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                chmod a+r /etc/apt/keyrings/docker.gpg
              register: gpg_key_mirror
              ignore_errors: yes
            
            - name: 如果镜像源失败，尝试从官方源下载 GPG 密钥
              shell: |
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                chmod a+r /etc/apt/keyrings/docker.gpg
              when: gpg_key_mirror is failed or gpg_key_mirror is skipped
              register: gpg_key_official
              ignore_errors: yes
            
            - name: 检查 GPG 密钥是否成功添加
              stat:
                path: /etc/apt/keyrings/docker.gpg
              register: gpg_key_file
            
            - name: 如果 GPG 密钥文件无效，删除并报告错误
              block:
                - name: 删除无效的 GPG 密钥文件
                  file:
                    path: /etc/apt/keyrings/docker.gpg
                    state: absent
                - name: 报告 GPG 密钥下载失败
                  fail:
                    msg: "无法下载 Docker GPG 密钥。已尝试阿里云镜像源和官方源，均失败。请检查网络连接。"
              when: not gpg_key_file.stat.exists or gpg_key_file.stat.size < 2000

        - name: 添加 Docker 仓库（优先使用国内镜像源）
          block:
            - name: 优先尝试使用阿里云镜像源添加 Docker 仓库
              shell: |
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu {{ ansible_distribution_release }} stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
              register: repo_mirror
              ignore_errors: yes
            
            - name: 如果镜像源失败，尝试添加官方 Docker 仓库
              shell: |
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
              when: repo_mirror is failed or repo_mirror is skipped
              register: repo_official
              ignore_errors: yes

        - name: 更新 apt 包索引（添加 Docker 仓库后）
          apt:
            update_cache: yes
          register: apt_update_docker
          ignore_errors: yes

        - name: 安装 Docker Engine（优先使用国内镜像源）
          block:
            - name: 优先尝试使用阿里云镜像源安装 Docker
              apt:
                name:
                  - docker-ce
                  - docker-ce-cli
                  - containerd.io
                  - docker-buildx-plugin
                  - docker-compose-plugin
                state: present
                update_cache: yes
              register: docker_install_mirror
              ignore_errors: yes
            
            - name: 如果镜像源失败，尝试从官方源安装 Docker
              apt:
                name:
                  - docker-ce
                  - docker-ce-cli
                  - containerd.io
                  - docker-buildx-plugin
                  - docker-compose-plugin
                state: present
                update_cache: yes
              when: docker_install_mirror is failed or docker_install_mirror is skipped
              register: docker_install_official
              ignore_errors: yes
            
            - name: 如果都失败，尝试使用 apt 默认仓库安装（版本可能较旧）
              apt:
                name:
                  - docker.io
                  - docker-compose
                state: present
              when: (docker_install_mirror is failed or docker_install_mirror is skipped) and (docker_install_official is failed or docker_install_official is skipped)
              register: docker_install_apt
              ignore_errors: yes

        - name: 检查 Docker 是否成功安装
          command: docker --version
          register: docker_check_after_install
          changed_when: false
          failed_when: false

        - name: 如果 Docker 仍未安装，报告错误
          fail:
            msg: "Docker 安装失败。已尝试官方源、阿里云镜像源和 apt 默认仓库，均失败。请检查网络连接或手动安装 Docker。"
          when: docker_check_after_install.rc != 0

        - name: 启动并启用 Docker 服务
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: 将用户添加到 docker 组
          user:
            name: "{{ ansible_user }}"
            groups: docker
            append: yes

        - name: 等待 Docker 服务就绪
          wait_for:
            path: /var/run/docker.sock
            state: present
            timeout: 30

    - name: 安装 Go 的 gRPC 工具
      shell: |
        export PATH=$PATH:/usr/local/go/bin
        export GOPATH={{ ansible_env.HOME }}/go
        mkdir -p $GOPATH/bin
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest || true
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest || true
      environment:
        PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"
        GOPATH: "{{ ansible_env.HOME }}/go"
      become_user: "{{ ansible_user }}"
      args:
        creates: "{{ ansible_env.HOME }}/go/bin/protoc-gen-go"

    - name: 创建 iarnet 目录
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      loop:
        - "{{ ansible_env.HOME }}/iarnet"
        - "{{ ansible_env.HOME }}/iarnet/data"
        - "{{ ansible_env.HOME }}/iarnet/workspaces"

    - name: 验证安装
      shell: |
        export PATH=$PATH:/usr/local/go/bin
        echo "=== Go ==="
        go version || echo "go not found"
        echo "=== Git ==="
        git --version || echo "git not found"
        echo "=== Protobuf ==="
        protoc --version || echo "protoc not found"
        echo "=== ZeroMQ ==="
        pkg-config --modversion libzmq || echo "zmq not found"
        echo "=== Node.js ==="
        node --version || echo "node not found"
        echo "=== npm ==="
        npm --version || echo "npm not found"
        echo "=== Docker ==="
        docker --version || echo "docker not found"
      register: verify_result
      changed_when: false
      become_user: "{{ ansible_user }}"

    - name: 显示验证结果
      debug:
        var: verify_result.stdout_lines

