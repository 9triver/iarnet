services:
  # Docker-in-Docker 1（为 Provider 1 提供独立的 Docker 环境）
  dind-1:
    image: docker:dind
    container_name: dind-1
    privileged: true
    volumes:
      # 持久化 Docker 数据（镜像、容器等），即使容器删除也能保留
      - dind-1-data:/var/lib/docker
    networks:
      - iarnet-testing-network
    ports:
      - "23751:2375"
    restart: unless-stopped
    environment:
      # 禁用 TLS（简化配置，生产环境建议启用）
      - DOCKER_TLS_CERTDIR=""
      # 允许通过 TCP 连接
      - DOCKER_HOST=tcp://0.0.0.0:2375
    command: ["dockerd", "--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock"]
    labels:
      - "dind.name=dind-1"
      - "dind.id=d1"

  # Docker-in-Docker 2（为 Provider 2 提供独立的 Docker 环境）
  dind-2:
    image: docker:dind
    container_name: dind-2
    privileged: true
    volumes:
      # 持久化 Docker 数据（镜像、容器等），即使容器删除也能保留
      - dind-2-data:/var/lib/docker
    networks:
      - iarnet-testing-network
    ports:
      - "23752:2375"
    restart: unless-stopped
    environment:
      # 禁用 TLS（简化配置，生产环境建议启用）
      - DOCKER_TLS_CERTDIR=""
      # 允许通过 TCP 连接
      - DOCKER_HOST=tcp://0.0.0.0:2375
    command: ["dockerd", "--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock"]
    labels:
      - "dind.name=dind-2"
      - "dind.id=d2"
  
  # Docker-in-Docker 3（为 Provider 3 提供独立的 Docker 环境）
  dind-3:
    image: docker:dind
    container_name: dind-3
    privileged: true
    volumes:
      # 持久化 Docker 数据（镜像、容器等），即使容器删除也能保留
      - dind-3-data:/var/lib/docker
    networks:
      - iarnet-testing-network
    ports:
      - "23753:2375"
    restart: unless-stopped
    environment:
      # 禁用 TLS（简化配置，生产环境建议启用）
      - DOCKER_TLS_CERTDIR=""
      # 允许通过 TCP 连接
      - DOCKER_HOST=tcp://0.0.0.0:2375
    command: ["dockerd", "--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock"]
    labels:
      - "dind.name=dind-3"
      - "dind.id=d3"

  # Docker Provider 1（连接到 dind-1）
  provider-docker-1:
    image: iarnet/provider:docker
    container_name: provider-docker-1
    depends_on:
      - dind-1
    volumes:
      # 挂载 Provider 1 的配置文件
      - ./provider/p1/config.yaml:/app/config.yaml:ro
    networks:
      - iarnet-testing-network
    restart: unless-stopped
    environment:
      # 通过 TCP 连接到 dind-1（使用容器名，在同一个网络中）
      - DOCKER_HOST=tcp://dind-1:2375
    labels:
      - "provider.name=provider-1"
      - "provider.id=p1"

  # Docker Provider 2（连接到 dind-2）
  provider-docker-2:
    image: iarnet/provider:docker
    container_name: provider-docker-2
    depends_on:
      - dind-2
    volumes:
      # 挂载 Provider 2 的配置文件
      - ./provider/p2/config.yaml:/app/config.yaml:ro
    networks:
      - iarnet-testing-network
    restart: unless-stopped
    environment:
      # 通过 TCP 连接到 dind-2（使用容器名，在同一个网络中）
      - DOCKER_HOST=tcp://dind-2:2375
    labels:
      - "provider.name=provider-2"
      - "provider.id=p2"

  # Docker Provider 3（连接到 dind-3）
  provider-docker-3:
    image: iarnet/provider:docker
    container_name: provider-docker-3
    depends_on:
      - dind-3
    volumes:
      # 挂载 Provider 3 的配置文件
      - ./provider/p3/config.yaml:/app/config.yaml:ro
    networks:
      - iarnet-testing-network
    restart: unless-stopped
    environment:
      # 通过 TCP 连接到 dind-3（使用容器名，在同一个网络中）
      - DOCKER_HOST=tcp://dind-3:2375
    labels:
      - "provider.name=provider-3"
      - "provider.id=p3"

  # Iarnet Global（全局注册中心）
  iarnet-global:
    image: iarnet-global:latest
    container_name: iarnet-global
    build:
      context: ../iarnet-global
      dockerfile: Dockerfile
    volumes:
      # 挂载数据目录（持久化）
      - ./global/data:/app/data
      # 挂载配置文件
      - ./global/config.yaml:/app/config.yaml:ro
    ports:
      - "3002:3000"   # 前端 Next.js 端口
    networks:
      - iarnet-testing-network
    restart: unless-stopped
    environment:
      # 后端 URL（前端使用）
      - BACKEND_URL=http://localhost:8080
    labels:
      - "app.name=iarnet-global"
      - "app.type=registry"

  # Iarnet 1（前后端一体化）
  iarnet-1:
    image: iarnet:latest
    container_name: iarnet-1
    build:
      context: ../iarnet
      dockerfile: Dockerfile
    privileged: true
    volumes:
      # 挂载数据目录（持久化）
      - ./iarnet/i1/data:/app/data
      # 挂载工作空间目录
      - ./iarnet/i1/workspaces:/app/workspaces
      # 挂载配置文件
      - ./iarnet/i1/config.yaml:/app/config.yaml:ro
      # Iarnet 内部 dind 的 Docker 数据
      - iarnet-1-docker:/var/lib/docker
    ports:
      - "3000:3000"  # 前端 Next.js 端口
      - "23761:2375" # Iarnet-1 dind
    networks:
      iarnet-testing-network:
        ipv4_address: 172.30.0.10
    extra_hosts:
      # 允许容器通过 host.docker.internal 访问宿主机（Linux 需要显式配置）
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    environment:
      # 后端 URL（前端使用）
      - BACKEND_URL=http://localhost:8083
      # 在 dind 中运行，允许 docker CLI 通过 unix socket 通信
      - DOCKER_TLS_CERTDIR=""
      - DOCKER_HOST=unix:///var/run/docker.sock
    labels:
      - "app.name=iarnet"
      - "app.instance=iarnet-1"

  # Iarnet 2（前后端一体化）
  iarnet-2:
    image: iarnet:latest
    container_name: iarnet-2
    build:
      context: ../iarnet
      dockerfile: Dockerfile
    privileged: true
    volumes:
      # 挂载数据目录（持久化）
      - ./iarnet/i2/data:/app/data
      # 挂载工作空间目录
      - ./iarnet/i2/workspaces:/app/workspaces
      # 挂载配置文件
      - ./iarnet/i2/config.yaml:/app/config.yaml:ro
      # Iarnet 内部 dind 的 Docker 数据
      - iarnet-2-docker:/var/lib/docker
    ports:
      - "3001:3000"  # 前端 Next.js 端口（使用不同的宿主机端口）
      - "23762:2375" # Iarnet-2 dind
    networks:
      iarnet-testing-network:
        ipv4_address: 172.30.0.11
    extra_hosts:
      # 允许容器通过 host.docker.internal 访问宿主机（Linux 需要显式配置）
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    environment:
      # 后端 URL（前端使用，注意端口映射）
      - BACKEND_URL=http://localhost:8084
      # 在 dind 中运行，允许 docker CLI 通过 unix socket 通信
      - DOCKER_TLS_CERTDIR=""
      - DOCKER_HOST=unix:///var/run/docker.sock
    labels:
      - "app.name=iarnet"
      - "app.instance=iarnet-2"

# Iarnet 3（前后端一体化）
  iarnet-3:
    image: iarnet:latest
    container_name: iarnet-3
    depends_on:
      - provider-docker-1
      - provider-docker-2
    build:
      context: ../iarnet
      dockerfile: Dockerfile
    privileged: true
    volumes:
      - ./iarnet/i3/data:/app/data
      - ./iarnet/i3/workspaces:/app/workspaces
      - ./iarnet/i3/config.yaml:/app/config.yaml:ro
      - iarnet-3-docker:/var/lib/docker
    ports:
      - "3003:3000"
      - "23763:2375"
    networks:
      iarnet-testing-network:
        ipv4_address: 172.30.0.12
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    environment:
      - BACKEND_URL=http://localhost:8085
      - DOCKER_TLS_CERTDIR=""
      - DOCKER_HOST=unix:///var/run/docker.sock
    labels:
      - "app.name=iarnet"
      - "app.instance=iarnet-3"

networks:
  iarnet-testing-network:
    driver: bridge
    name: iarnet-testing-network
    ipam:
      config:
        - subnet: 172.30.0.0/24

volumes:
  # dind-1 的 Docker 数据持久化卷
  # 存储所有 Docker 数据（镜像、容器、网络、卷等）
  # 即使容器删除，数据也会保留
  dind-1-data:
    driver: local
    name: dind-1-data
  # dind-2 的 Docker 数据持久化卷
  # 存储所有 Docker 数据（镜像、容器、网络、卷等）
  # 即使容器删除，数据也会保留
  dind-2-data:
    driver: local
    name: dind-2-data
  # dind-3 的 Docker 数据持久化卷
  # 存储所有 Docker 数据（镜像、容器、网络、卷等）
  # 即使容器删除，数据也会保留
  dind-3-data:
    driver: local
    name: dind-3-data
  iarnet-1-docker:
    driver: local
    name: iarnet-1-docker
  iarnet-2-docker:
    driver: local
    name: iarnet-2-docker
  iarnet-3-docker:
    driver: local
    name: iarnet-3-docker

